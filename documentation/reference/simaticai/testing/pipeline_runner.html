
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.5.0">
    
    
      
        <title>Pipeline Runner - AI Software Development Kit</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2e8b5541.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../styles.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-simaticaitestingpipeline_runner" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../index.html" title="AI Software Development Kit" class="md-header__button md-logo" aria-label="AI Software Development Kit" data-md-component="logo">
      
  <img src="../../../Sie_logo_white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AI Software Development Kit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pipeline Runner
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../index.html" title="AI Software Development Kit" class="md-nav__button md-logo" aria-label="AI Software Development Kit" data-md-component="logo">
      
  <img src="../../../Sie_logo_white.svg" alt="logo">

    </a>
    AI Software Development Kit
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../index.html" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../CHANGELOG.html" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../user_manual.html" class="md-nav__link">
        User Manual
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Log Module
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Log Module" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Log Module
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../log_module/index.html" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../log_module/mock_logger.html" class="md-nav__link">
        Mock Logger
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Simaticai
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Simaticai" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Simaticai
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deployment.html" class="md-nav__link">
        Deployment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../model_config_pb2.html" class="md-nav__link">
        Model Config Pb2
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_4" type="checkbox" id="__nav_4_2_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_4">
          Data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Data" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_4">
          <span class="md-nav__icon md-icon"></span>
          Data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data/index.html" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data/schemas.html" class="md-nav__link">
        Schemas
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_5" type="checkbox" id="__nav_4_2_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_5">
          Helpers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Helpers" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_5">
          <span class="md-nav__icon md-icon"></span>
          Helpers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../helpers/index.html" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../helpers/model_config.html" class="md-nav__link">
        Model Config
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../helpers/pep508.html" class="md-nav__link">
        Pep508
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../helpers/tempfiles.html" class="md-nav__link">
        Tempfiles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../helpers/yaml_helper.html" class="md-nav__link">
        Yaml Helper
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_6" type="checkbox" id="__nav_4_2_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_6">
          Packaging
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Packaging" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_6">
          <span class="md-nav__icon md-icon"></span>
          Packaging
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../packaging/constants.html" class="md-nav__link">
        Constants
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../packaging/index.html" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../packaging/python_dependencies.html" class="md-nav__link">
        Python Dependencies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../packaging/wheelhouse.html" class="md-nav__link">
        Wheelhouse
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_7" type="checkbox" id="__nav_4_2_7" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_7">
          Testing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Testing" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_7">
          <span class="md-nav__icon md-icon"></span>
          Testing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Pipeline Runner
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="pipeline_runner.html" class="md-nav__link md-nav__link--active">
        Pipeline Runner
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validate_payload" class="md-nav__link">
    validate_payload
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate_payload_item" class="md-nav__link">
    validate_payload_item
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#localpipelinerunner" class="md-nav__link">
    LocalPipelineRunner
  </a>
  
    <nav class="md-nav" aria-label="LocalPipelineRunner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collect_telemetry_data" class="md-nav__link">
    collect_telemetry_data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run_component" class="md-nav__link">
    run_component
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run_pipeline" class="md-nav__link">
    run_pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_parameters" class="md-nav__link">
    update_parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_telemetry_data" class="md-nav__link">
    update_telemetry_data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pipeline_validator.html" class="md-nav__link">
        Pipeline Validator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="run_component.html" class="md-nav__link">
        Run Component
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="run_gpuruntime_component.html" class="md-nav__link">
        Run Gpuruntime Component
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validate_payload" class="md-nav__link">
    validate_payload
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate_payload_item" class="md-nav__link">
    validate_payload_item
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#localpipelinerunner" class="md-nav__link">
    LocalPipelineRunner
  </a>
  
    <nav class="md-nav" aria-label="LocalPipelineRunner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collect_telemetry_data" class="md-nav__link">
    collect_telemetry_data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run_component" class="md-nav__link">
    run_component
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run_pipeline" class="md-nav__link">
    run_pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_parameters" class="md-nav__link">
    update_parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_telemetry_data" class="md-nav__link">
    update_telemetry_data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="module-simaticaitestingpipeline_runner">Module simaticai.testing.pipeline_runner</h1>
<p>A pipeline runner that lets you simulate the execution of a pipeline in a local Python environment.</p>
<p>It can be used to locally mimic the behavior of the AI Inference Server concerning loading and running inference pipelines.
This is a quick and easy way to find programming or configuration errors before deploying the package.
The local pipeline runner also lets you exercise your pipeline component by component. In other words, you can feed
single components with inputs and verify the output produced.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="c1"># Copyright (C) Siemens AG 2021. All Rights Reserved. Confidential.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">A pipeline runner that lets you simulate the execution of a pipeline in a local Python environment.</span>

<span class="sd">It can be used to locally mimic the behavior of the AI Inference Server concerning loading and running inference pipelines.</span>

<span class="sd">This is a quick and easy way to find programming or configuration errors before deploying the package.</span>

<span class="sd">The local pipeline runner also lets you exercise your pipeline component by component. In other words, you can feed</span>

<span class="sd">single components with inputs and verify the output produced.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pkg_resources</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">venv</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">importlib</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">importlib_metadata</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Union</span><span class="p">,</span><span class="w"> </span><span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">simaticai.helpers</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">calc_sha</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">simaticai.helpers.pep508</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">parse_requirements</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">simaticai.packaging.constants</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>

<span class="w">    </span><span class="n">REQUIREMENTS_TXT</span><span class="p">,</span><span class="w"> </span><span class="n">TELEMETRY_YAML</span><span class="p">,</span>

<span class="w">    </span><span class="n">PYTHON_PACKAGES</span><span class="p">,</span><span class="w"> </span><span class="n">PYTHON_PACKAGES_ZIP</span><span class="p">,</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">simaticai.testing.pipeline_validator</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">INVALID_PIPELINE_PACKAGE_MESSAGE</span>

<span class="n">RETURN_CODE_OK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b0</span>

<span class="n">RETURN_CODE_DEPRECATED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b10001</span><span class="w">  </span><span class="c1"># equals to 17</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>

<span class="n">_logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">_runner_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>

<span class="n">type_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="s1">&#39;int&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Integer&#39;</span><span class="p">,</span>

<span class="w">    </span><span class="s1">&#39;float&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Double&#39;</span><span class="p">,</span>

<span class="w">    </span><span class="s1">&#39;bool&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Boolean&#39;</span><span class="p">,</span>

<span class="w">    </span><span class="s1">&#39;str&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;String&#39;</span>

<span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LocalPipelineRunner</span><span class="p">:</span>

<span class="w">    </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    Simulates the execution of a pipeline in a local Python environment.</span>

<span class="s2">    Only works with a pipeline configuration package. Does not work with e.g. an edge configuration package.</span>

<span class="s2">    Restriction: only linear pipelines are supported where the pipeline input variables are only used by one component,</span>

<span class="s2">    each component uses only the outputs of the previous components, and the pipeline output only consists of variables from the last component.</span>

<span class="s2">    If the caller specifies no `path`, the working directory is temporary and is removed unless an error occurs.</span>

<span class="s2">    If the caller specifies a working directory with a `path` argument, the working directory is kept.</span>

<span class="s2">    This behavior can be overridden using boolean parameter `cleanup`.</span>

<span class="s2">    Currently, the pipeline runner supports both the current `process_input(data: dict)` entrypoint signature and the legacy</span>

<span class="s2">    `run(data: str)` signature. If both entrypoints are present, `process_input()` takes precedence. Please note however that</span>

<span class="s2">    `run()` is deprecated, and support for it will be removed in future versions of the pipeline runner.</span>

<span class="s2">    Args:</span>

<span class="s2">        packageZip (path-like): Path to the pipeline configuration package.</span>

<span class="s2">        path (path-like): Path to the working directory. If unset, a temporary directory is created.</span>

<span class="s2">        cleanup (bool): If set, the working directory is kept when True, and deleted when False. </span><span class="se">\</span>

<span class="s2">            If unset, a temporary working directory is removed, and an explicit working directory is kept. </span><span class="se">\</span>

<span class="s2">            When an error occurs in a component, the working directory is kept regardless of this value.</span>

<span class="s2">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">packageZip</span><span class="p">:</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span><span class="w"> </span><span class="n">cleanup</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span><span class="w"> </span><span class="n">loglevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Creates a new component LocalPipelineRunner for the provided pipeline configuration package.</span>

<span class="s2">        Only works with a pipeline configuration package. Does not work with e.g. an edge configuration package.</span>

<span class="s2">        Args:</span>

<span class="s2">            packageZip (path-like): Path to the pipeline configuration package.</span>

<span class="s2">            path (path-like): Path to the working directory. If unset a temporary directory will be created.</span>

<span class="s2">            cleanup (bool): If set, the working directory will be kept when True, and deleted when False. </span><span class="se">\</span>

<span class="s2">                If unset, a temporary working directory will be removed, and an explicit working directory will be kept. </span><span class="se">\</span>

<span class="s2">                When an error occurs in a component, the working directory will be kept regardless of this value.</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">:</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">packageZip</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cleanup</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loglevel</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">:</span><span class="w"> </span><span class="n">Path</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-:]&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">timespec</span><span class="o">=</span><span class="s2">&quot;seconds&quot;</span><span class="p">))</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="w"> </span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">False</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;LocalPipelineRunner_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">))</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">True</span>

<span class="w">        </span><span class="n">unzip_components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span>

<span class="w">        </span><span class="k">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zf</span><span class="p">:</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;runtime_config.yml&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="o">.</span><span class="n">stem</span>

<span class="w">                </span><span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

<span class="w">                </span><span class="n">unzip_components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span>

<span class="w">            </span><span class="k">else</span><span class="p">:</span>

<span class="w">                </span><span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">        </span><span class="k">try</span><span class="p">:</span>

<span class="w">            </span><span class="k">with</span><span class="w"> </span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;pipeline_config.yml&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cf</span><span class="p">:</span>

<span class="w">                </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span><span class="w"> </span><span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>

<span class="w">            </span><span class="n">components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataFlowPipeline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;components&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">components</span><span class="p">:</span>

<span class="w">                </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">None</span>

<span class="w">                </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">unzip_components</span><span class="p">:</span>

<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">components</span><span class="p">:</span>

<span class="w">                    </span><span class="n">component_zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.zip&quot;</span>

<span class="w">                    </span><span class="k">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;components&#39;</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">component_zip</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zf</span><span class="p">:</span>

<span class="w">                        </span><span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataFlowPipeline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipelineParameters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{}):</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">parameter</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameter</span>

<span class="w">        </span><span class="k">except</span><span class="w"> </span><span class="n">Exception</span><span class="p">:</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="n">INVALID_PIPELINE_PACKAGE_MESSAGE</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">exception_type</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">traceback</span><span class="p">):</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">update_telemetry_data</span><span class="p">()</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing local pipeline runner environment...&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaving local pipeline runner environment in its final state at &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">collect_telemetry_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Collects telemetry data about the platform, environment, industrial AI packages, and pipeline.</span>

<span class="s2">        Returns:</span>

<span class="s2">            dict: A dictionary containing the telemetry data.</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">][</span><span class="s2">&quot;os&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">][</span><span class="s2">&quot;release&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">][</span><span class="s2">&quot;python_version&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform</span><span class="o">.</span><span class="n">python_version</span><span class="p">()</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;locals: </span><span class="si">{</span><span class="nb">locals</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">][</span><span class="s2">&quot;jupyter&quot;</span><span class="p">]</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">locals</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;__IPYTHON__&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;get_ipython&quot;</span><span class="p">])</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">][</span><span class="s2">&quot;gitlab_ci&quot;</span><span class="p">]</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s2">&quot;GITLAB_CI&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">][</span><span class="s2">&quot;azure_devops&quot;</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s2">&quot;TF_BUILD&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">][</span><span class="s2">&quot;github_actions&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s2">&quot;GITHUB_ACTIONS&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;industrial_ai&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="k">try</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;industrial_ai&quot;</span><span class="p">][</span><span class="s2">&quot;simaticai&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="s2">&quot;simaticai&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>

<span class="w">        </span><span class="k">except</span><span class="w"> </span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">DistributionNotFound</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;industrial_ai&quot;</span><span class="p">][</span><span class="s2">&quot;simaticai&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="k">try</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;industrial_ai&quot;</span><span class="p">][</span><span class="s2">&quot;vep-template-sdk&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="s2">&quot;vep-template-sdk&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>

<span class="w">        </span><span class="k">except</span><span class="w"> </span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">DistributionNotFound</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;industrial_ai&quot;</span><span class="p">][</span><span class="s2">&quot;vep-template-sdk&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;python_versions&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">component</span><span class="p">][</span><span class="s1">&#39;runtime&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">component</span><span class="p">][</span><span class="s1">&#39;runtime&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="p">))</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;file_extensions&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">component_dir</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>

<span class="w">            </span><span class="c1"># pathlib is_relative_to is deprecated since version 3.12, will be removed in version 3.14</span>

<span class="w">            </span><span class="n">excluded_dirs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">set</span><span class="p">([</span><span class="n">component_dir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;.venv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component_dir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;__pyache__&#39;</span><span class="p">])</span>

<span class="w">            </span><span class="n">suffixes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">suffix</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">component_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">excluded_dirs</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">parents</span><span class="p">))</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">f</span><span class="o">.</span><span class="n">suffix</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.zip&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.yml&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.yaml&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.html&quot;</span><span class="p">])))</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">suffix</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">suffixes</span><span class="p">:</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">suffix</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;file_extensions&quot;</span><span class="p">]:</span>

<span class="w">                    </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;file_extensions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">telemetry_data</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">update_telemetry_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Update the telemetry data and the package.</span>

<span class="s2">        This method updates the telemetry data by loading the existing data from a YAML file,</span>

<span class="s2">        or collecting new telemetry data if the file doesn&#39;t exist. It then updates the</span>

<span class="s2">        &quot;last_run&quot; field of the telemetry data with the current timestamp. The updated</span>

<span class="s2">        telemetry data is then written back to the YAML file.</span>

<span class="s2">        If the package contains a different version of the telemetry data file, a new package</span>

<span class="s2">        is created with the updated telemetry data. Otherwise, the existing package is</span>

<span class="s2">        overwritten with the new package containing the updated telemetry data.</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating telemetry data and the package&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">telemetry_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;telemetry_data.yml&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">telemetry_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">telemetry_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">collect_telemetry_data</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;last_run&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">telemetry_data</span><span class="p">))</span>

<span class="w">        </span><span class="n">config_package</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span>

<span class="w">        </span><span class="k">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zip_read</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">zip_read</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">TELEMETRY_YAML</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TELEMETRY_YAML</span><span class="p">:</span>

<span class="w">                    </span><span class="n">config_package</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span>

<span class="w">                    </span><span class="k">break</span>

<span class="w">        </span><span class="n">new_zip_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_tested.zip&quot;</span>

<span class="w">        </span><span class="k">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zip_read</span><span class="p">:</span>

<span class="w">            </span><span class="k">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">new_zip_path</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zip_write</span><span class="p">:</span>

<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">zip_read</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">TELEMETRY_YAML</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">file</span><span class="p">:</span>

<span class="w">                        </span><span class="n">filepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zip_read</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

<span class="w">                        </span><span class="n">zip_write</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span><span class="w"> </span><span class="n">arcname</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

<span class="w">                    </span><span class="k">else</span><span class="p">:</span>

<span class="w">                        </span><span class="n">zip_write</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">telemetry_path</span><span class="p">,</span><span class="w"> </span><span class="n">arcname</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">config_package</span><span class="p">:</span>

<span class="w">            </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">new_zip_path</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">new_sha_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_tested.sha256&quot;</span>

<span class="w">            </span><span class="n">new_sha_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">calc_sha</span><span class="p">(</span><span class="n">new_zip_path</span><span class="p">))</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_install_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">,</span><span class="w"> </span><span class="n">no_index</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span><span class="p">):</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Installing requirements...&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>

<span class="w">            </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;bin_path&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pip&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;install&quot;</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;--no-python-version-warning&quot;</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;--no-warn-script-location&quot;</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;-f&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">package_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span>

<span class="w">            </span><span class="s2">&quot;-r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">REQUIREMENTS_TXT</span><span class="w"> </span><span class="p">]</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">no_index</span><span class="p">:</span>

<span class="w">            </span><span class="n">cmd</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;--no-index&quot;</span><span class="w"> </span><span class="p">]</span>

<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">cwd</span><span class="o">=</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">returncode</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_install_from_packages_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">):</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_install_requirements</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">,</span><span class="w"> </span><span class="kc">True</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_install_from_pypi_org</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">):</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_install_requirements</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">,</span><span class="w"> </span><span class="kc">False</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_init_component_venv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">:</span><span class="w"> </span><span class="nb">dict</span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Creates a virtual environment in which the given component can run.</span>

<span class="s2">        Args:</span>

<span class="s2">            component (str): name of the selected component.</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating virtual environment for component &#39;</span><span class="si">{</span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">context_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;.venv&quot;</span>

<span class="w">        </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">venv</span><span class="o">.</span><span class="n">EnvBuilder</span><span class="p">(</span><span class="n">with_pip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="w">        </span><span class="n">builder</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">context_dir</span><span class="p">))</span>

<span class="w">        </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">(</span><span class="n">context_dir</span><span class="p">)</span>

<span class="w">        </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;bin_path&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bin_path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component bin path: </span><span class="si">{</span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;bin_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Upgrading pip...&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;bin_path&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pip&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;install&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pip&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--upgrade&quot;</span><span class="p">]</span>

<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">cwd</span><span class="o">=</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error upgrading pip:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">try</span><span class="p">:</span>

<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_install_logmodule</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;bin_path&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">])</span>

<span class="w">        </span><span class="k">except</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">err</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The &#39;simaticai&#39; Python package is either not installed or does not contain package &#39;log_module&#39;.&quot;</span><span class="p">)</span><span class="w"> </span><span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error installing log_module:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">req_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;requirements.list&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">req_list</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">REQUIREMENTS_TXT</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

<span class="w">            </span><span class="n">dependencies</span><span class="p">,</span><span class="w"> </span><span class="n">extra_index</span><span class="p">,</span><span class="w"> </span><span class="n">index_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_requirements</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">REQUIREMENTS_TXT</span><span class="p">)</span>

<span class="w">            </span><span class="n">requirements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;#&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dependencies</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="w">            </span><span class="n">req_list</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">requirements</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">REQUIREMENTS_TXT</span><span class="si">}</span><span class="s2">&#39; was not found. No additional dependencies were installed.&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="k">return</span>

<span class="w">        </span><span class="n">package_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PYTHON_PACKAGES</span>

<span class="w">        </span><span class="n">package_zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PYTHON_PACKAGES_ZIP</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting </span><span class="si">{</span><span class="n">PYTHON_PACKAGES_ZIP</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">package_zip</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

<span class="w">            </span><span class="k">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">package_zip</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zf</span><span class="p">:</span>

<span class="w">                </span><span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">package_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There is no </span><span class="si">{</span><span class="n">PYTHON_PACKAGES_ZIP</span><span class="si">}</span><span class="s2"> to extract.&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="n">package_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="w"> </span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="w">        </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_install_from_packages_zip</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">success</span><span class="p">:</span>

<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;Warning! Could not install dependencies from </span><span class="si">{</span><span class="n">PYTHON_PACKAGES_ZIP</span><span class="si">}</span><span class="s2">. &quot;</span>

<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;Trying to install them from pypi.org. The resulting Python environment &quot;</span>

<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;may be significantly different than the targeted Python environment on the Edge Device!&quot;</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="w">            </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_install_from_pypi_org</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">success</span><span class="p">:</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span>

<span class="w">                </span><span class="k">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error installing requirements:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="nd">@staticmethod</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_install_logmodule</span><span class="p">(</span><span class="n">bin_path</span><span class="p">,</span><span class="w"> </span><span class="n">env_dir</span><span class="p">):</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Installing LogModule...&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">try</span><span class="p">:</span>

<span class="w">            </span><span class="n">package_paths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">importlib_metadata</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;simaticai&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="n">package_paths</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span>

<span class="w">            </span><span class="n">logger_wheel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">package_paths</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;log_module&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">locate</span><span class="p">()</span>

<span class="w">        </span><span class="k">except</span><span class="w"> </span><span class="n">Exception</span><span class="p">:</span>

<span class="w">            </span><span class="kn">from</span><span class="w"> </span><span class="nn">importlib.metadata</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Distribution</span>

<span class="w">            </span><span class="n">direct_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Distribution</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="s2">&quot;simaticai&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="s2">&quot;direct_url.json&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="n">direct_url</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span>

<span class="w">            </span><span class="n">direct_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">direct_url</span><span class="p">)[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>

<span class="w">            </span><span class="n">direct_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">direct_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="w">            </span><span class="n">direct_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">direct_url</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;simaticai&#39;</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;data&#39;</span>

<span class="w">            </span><span class="n">paths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">list</span><span class="p">(</span><span class="n">direct_url</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;*.whl&#39;</span><span class="p">))</span>

<span class="w">            </span><span class="n">logger_wheel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">paths</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;log_module&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

<span class="w">        </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bin_path</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;pip&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;install&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--no-python-version-warning&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--no-warn-script-location&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">logger_wheel</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;joblib&quot;</span><span class="p">]</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">cwd</span><span class="o">=</span><span class="n">env_dir</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">run_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">]])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">]]:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Runs the component in its virtual environment with the given input.</span>

<span class="s2">        This environment is created according to `requirements.txt` in the package.</span>

<span class="s2">        Additionally &#39;joblib&#39; and the mock `log_module` is automatically installed in this virtual environment.</span>

<span class="s2">        The input data can be a single input record in a dictionary or a batch of input records in a list of dictionaries.</span>

<span class="s2">        The supplied input data is saved as `inputs.joblib` in the component runtime directory, and the output is saved as `output.joblib`.</span>

<span class="s2">        Args:</span>

<span class="s2">            name (str): The name of the component to be executed.</span>

<span class="s2">            data (dict or list): One or more input records for the component.</span>

<span class="s2">        Returns:</span>

<span class="s2">            dict / list: A list of dictionaries for outputs if there were no errors and field `ready` is true.</span>

<span class="s2">            If the input was a single dict, then a single dict (the first item of the list) or None if there is no output.</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;Invalid component name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;runtime&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gpuruntime&quot;</span><span class="p">],</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;Can not run component &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: Runtime type is nor &#39;python&#39; or &#39;gpuruntime&#39;&quot;</span>

<span class="w">        </span><span class="n">input_payload_path</span><span class="p">:</span><span class="w"> </span><span class="n">Path</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;input.joblib&quot;</span>

<span class="w">        </span><span class="n">output_payload_path</span><span class="p">:</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;output.joblib&quot;</span>

<span class="w">        </span><span class="n">batch_input</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">][</span><span class="s2">&quot;inputBatch&quot;</span><span class="p">]</span><span class="w">  </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Yes&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">False</span>

<span class="w">        </span><span class="n">batch_output</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">][</span><span class="s2">&quot;outputBatch&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Yes&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">False</span>

<span class="w">        </span><span class="c1"># Validate and serialize input payload</span>

<span class="w">        </span><span class="k">assert</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;Can not run component &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; without input.&quot;</span>

<span class="w">        </span><span class="n">input_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">[</span><span class="n">data</span><span class="p">]</span>

<span class="w">        </span><span class="n">validate_payload</span><span class="p">(</span><span class="n">input_payload</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;inputType&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">batch_input</span><span class="p">)</span>

<span class="w">        </span><span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">input_payload</span><span class="p">,</span><span class="w"> </span><span class="n">input_payload_path</span><span class="p">)</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input payload saved as &#39;</span><span class="si">{</span><span class="n">input_payload_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Assemble command for runnig component</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;runtime&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># Version check for Python</span>

<span class="w">            </span><span class="n">e_major</span><span class="p">,</span><span class="w"> </span><span class="n">e_minor</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span>

<span class="w">            </span><span class="n">c_major</span><span class="p">,</span><span class="w"> </span><span class="n">c_minor</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;runtime&quot;</span><span class="p">][</span><span class="s2">&quot;version&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e_major</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">e_minor</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c_major</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">c_minor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span>

<span class="w">                </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;The local python version (</span><span class="si">{</span><span class="n">e_major</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">e_minor</span><span class="si">}</span><span class="s2">) and the python version defined for the component (</span><span class="si">{</span><span class="n">c_major</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">c_minor</span><span class="si">}</span><span class="s2">) are different.&quot;</span>

<span class="w">                </span><span class="n">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot; Testing will be done using dependencies that corresponds to the python version of your development environment.&quot;</span>

<span class="w">                </span><span class="n">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot; Pipeline behavior on AI Inference Server might be different.&quot;</span>

<span class="w">                </span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">_init_component_venv</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;run_component.py&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">])</span>

<span class="w">            </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;run_component&#39;</span><span class="p">,</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;entrypoint&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span>

<span class="w">                </span><span class="s2">&quot;-p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span><span class="w"> </span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;defaultValue&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()}),</span>

<span class="w">                </span><span class="s2">&quot;-r&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;requirements.list&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span>

<span class="w">            </span><span class="p">]</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># gpuruntime step requires Python environment with onnxruntime installed</span>

<span class="w">            </span><span class="c1"># TODO: check gpuruntime version if needed</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;gpuruntime_requirements.txt&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">REQUIREMENTS_TXT</span><span class="p">)</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">_init_component_venv</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;run_gpuruntime_component.py&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">])</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;model_config_pb2.py&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">])</span>

<span class="w">            </span><span class="n">model_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;entrypoint&quot;</span><span class="p">])</span>

<span class="w">            </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;run_gpuruntime_component&#39;</span><span class="p">,</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span>

<span class="w">                </span><span class="s2">&quot;-c&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;config.pbtxt&quot;</span><span class="p">),</span>

<span class="w">            </span><span class="p">]</span>

<span class="w">        </span><span class="n">args</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span>

<span class="w">            </span><span class="s2">&quot;-i&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">input_payload_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;-o&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">output_payload_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;-ll&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

<span class="w">        </span><span class="p">]</span>

<span class="w">        </span><span class="c1"># Run the component in the created Python environment</span>

<span class="w">        </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;bin_path&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="p">)]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">args</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running command: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

<span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">cwd</span><span class="o">=</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>

<span class="w">                </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

<span class="w">        </span><span class="n">returncode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">returncode</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">RETURN_CODE_OK</span><span class="p">,</span><span class="w"> </span><span class="n">RETURN_CODE_DEPRECATED</span><span class="p">]:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">False</span>

<span class="w">            </span><span class="k">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>

<span class="s2">There was an error while running component &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.</span>

<span class="s2">You can check the test results in directory &#39;</span><span class="si">{</span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;env_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;</span>

<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">response_wrapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">returncode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RETURN_CODE_DEPRECATED</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">False</span>

<span class="w">        </span><span class="c1"># Deserialize and validate output payload</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading output payload from &#39;</span><span class="si">{</span><span class="n">output_payload_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">output_payload_path</span><span class="p">)</span>

<span class="w">        </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">output_payload</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">[</span><span class="n">output_payload</span><span class="p">]</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">response_wrapped</span><span class="p">:</span>

<span class="w">            </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;ready&#39;</span><span class="p">]]</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">output</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="p">]</span>

<span class="w">        </span><span class="n">validate_payload</span><span class="p">(</span><span class="n">output_payload</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;outputType&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">batch_output</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Only return the first item if the input was a single item, or None if there are no valid results.</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">output_payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">output_payload</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">:</span><span class="w"> </span><span class="nb">dict</span><span class="p">):</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Validates and updates pipeline parameters.</span>

<span class="s2">        The elements of the dictionary must match the parameters specified in the pipeline configuration package.</span>

<span class="s2">        If any of the names or types does not match, all parameters will remain untouched.</span>

<span class="s2">        Args:</span>

<span class="s2">            parameters (dict): names and values of parameters to update</span>

<span class="s2">        Raises:</span>

<span class="s2">            AssertionError:</span>

<span class="s2">                When:</span>

<span class="s2">                - either `name` is not in the configured parameters,</span>

<span class="s2">                - or `defaultValue` type is different from the configured one</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">type_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>

<span class="w">                </span><span class="k">raise</span><span class="w"> </span><span class="n">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipeline has no parameters with the name &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; and type &#39;</span><span class="si">{</span><span class="n">type_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;defaultValue&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">run_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">]]:</span>

<span class="w">        </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Runs all the components sequentially, assuming the output of a component is only consumed by the next.</span>

<span class="s2">        The input data can be a single input record in a dictionary or a batch of input records in a list of dictionaries.</span>

<span class="s2">        For each component the supplied input data is saved as `input.joblib` in the component runtime directory,</span>

<span class="s2">        and the output is saved as `output.joblib`.</span>

<span class="s2">        Args:</span>

<span class="s2">            payload (dict or list): One or more input records for the pipeline.</span>

<span class="s2">        Returns:</span>

<span class="s2">            The output of the last component.</span>

<span class="s2">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

<span class="w">            </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">run_component</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">payload</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_payload</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nb">list</span><span class="p">,</span><span class="w"> </span><span class="n">variables</span><span class="p">:</span><span class="w"> </span><span class="nb">list</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="p">:</span><span class="w"> </span><span class="nb">bool</span><span class="p">):</span>

<span class="w">    </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    Validates that data is a valid list of input or output payload items.</span>

<span class="s2">    Variables list what variables each playload item has.</span>

<span class="s2">    Batch indicates if the payload items are themselves batches of items or not.</span>

<span class="s2">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="k">assert</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;payload data must be a &#39;list&#39;&quot;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">data</span><span class="p">:</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">batch</span><span class="p">:</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;batch payload items must be &#39;list&#39; instances&quot;</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">i</span><span class="p">:</span>

<span class="w">            </span><span class="n">validate_payload_item</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">variables</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_payload_item</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nb">dict</span><span class="p">,</span><span class="w"> </span><span class="n">variables</span><span class="p">:</span><span class="w"> </span><span class="nb">list</span><span class="p">):</span>

<span class="w">    </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    Validates that data is a valid payload item.</span>

<span class="s2">    Variables listed must have a corresponding field in data.</span>

<span class="s2">    The types of the values must match their declared type.</span>

<span class="s2">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="k">assert</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="nb">dict</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;payload items must be &#39;dict&#39; isntances&quot;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">variables</span><span class="p">:</span>

<span class="w">        </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">variable</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING! Variable &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is missing from input, output or metric&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="k">continue</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">variable</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;String&quot;</span><span class="p">:</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&#39;String&#39; value must be an &#39;str&#39;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">variable</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;StringArray&quot;</span><span class="p">:</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="nb">list</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&#39;StringArray&#39; value must be a &#39;list&#39;&quot;</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">value</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&#39;StringArray&#39; items must be &#39;str&#39; isntances&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">variable</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Object&quot;</span><span class="p">:</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="nb">dict</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&#39;Object&#39; value must be a &#39;dict&#39;&quot;</span>

<span class="w">            </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&#39;Object&#39; value must have exactly 2 items&quot;</span>

<span class="w">            </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="nb">bytes</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="nb">bytes</span><span class="p">)</span>

<span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&#39;Object&#39; value must have exactly one &#39;str&#39; and one &#39;bytes&#39; field&quot;</span>

<span class="w">    </span><span class="n">payload_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="w">    </span><span class="n">variable_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">variable</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">extra_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">payload_names</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">variable_names</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">extra_variables</span><span class="p">):</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING! These variables are not declared but are part of the payload: </span><span class="si">{</span><span class="n">extra_variables</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

</details>
<h2 id="variables">Variables</h2>
<div class="codehilite"><pre><span></span><code><span class="n">INVALID_PIPELINE_PACKAGE_MESSAGE</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">MSG_NOT_FOUND</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">PYTHON_PACKAGES</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">PYTHON_PACKAGES_ZIP</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">REQUIREMENTS_TXT</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">RETURN_CODE_DEPRECATED</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">RETURN_CODE_OK</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">TELEMETRY_YAML</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">type_map</span>
</code></pre></div>

<h2 id="functions">Functions</h2>
<h3 id="validate_payload">validate_payload</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_payload</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">variables</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">batch</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span>
</code></pre></div>

<p>Validates that data is a valid list of input or output payload items.</p>
<p>Variables list what variables each playload item has.
Batch indicates if the payload items are themselves batches of items or not.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">validate_payload</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">variables</span><span class="p">:</span><span class="w"> </span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Validates that data is a valid list of input or output payload items.</span>

<span class="sd">    Variables list what variables each playload item has.</span>

<span class="sd">    Batch indicates if the payload items are themselves batches of items or not.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="nb">assert</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;payload data must be a &#39;list&#39;&quot;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">data</span><span class="p">:</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">batch</span><span class="p">:</span>

<span class="w">            </span><span class="nb">assert</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;batch payload items must be &#39;list&#39; instances&quot;</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">i</span><span class="p">:</span>

<span class="w">            </span><span class="n">validate_payload_item</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">variables</span><span class="p">)</span>
</code></pre></div>

</details>
<h3 id="validate_payload_item">validate_payload_item</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_payload_item</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">variables</span><span class="p">:</span> <span class="nb">list</span>
<span class="p">)</span>
</code></pre></div>

<p>Validates that data is a valid payload item.</p>
<p>Variables listed must have a corresponding field in data.
The types of the values must match their declared type.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">validate_payload_item</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">dict</span><span class="p">,</span><span class="w"> </span><span class="n">variables</span><span class="p">:</span><span class="w"> </span><span class="n">list</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Validates that data is a valid payload item.</span>

<span class="sd">    Variables listed must have a corresponding field in data.</span>

<span class="sd">    The types of the values must match their declared type.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="nb">assert</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">dict</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;payload items must be &#39;dict&#39; isntances&quot;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">variables</span><span class="p">:</span>

<span class="w">        </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">variable</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">None</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;WARNING! Variable &#39;{name}&#39; is missing from input, output or metric&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="k">continue</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">variable</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;String&quot;</span><span class="p">:</span>

<span class="w">            </span><span class="nb">assert</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&#39;String&#39; value must be an &#39;str&#39;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">variable</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;StringArray&quot;</span><span class="p">:</span>

<span class="w">            </span><span class="nb">assert</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&#39;StringArray&#39; value must be a &#39;list&#39;&quot;</span>

<span class="w">            </span><span class="nb">assert</span><span class="w"> </span><span class="n">all</span><span class="p">(</span><span class="n">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">value</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&#39;StringArray&#39; items must be &#39;str&#39; isntances&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">variable</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Object&quot;</span><span class="p">:</span>

<span class="w">            </span><span class="nb">assert</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">dict</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;&#39;Object&#39; value must be a &#39;dict&#39;&quot;</span>

<span class="w">            </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="w">            </span><span class="nb">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&#39;Object&#39; value must have exactly 2 items&quot;</span>

<span class="w">            </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span>

<span class="w">            </span><span class="nb">assert</span><span class="w"> </span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&#39;Object&#39; value must have exactly one &#39;str&#39; and one &#39;bytes&#39; field&quot;</span>

<span class="w">    </span><span class="n">payload_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="w">    </span><span class="n">variable_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">variable</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">extra_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">payload_names</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">variable_names</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">extra_variables</span><span class="p">):</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;WARNING! These variables are not declared but are part of the payload: {extra_variables}&quot;</span><span class="p">)</span>
</code></pre></div>

</details>
<h2 id="classes">Classes</h2>
<h3 id="localpipelinerunner">LocalPipelineRunner</h3>
<p>Simulates the execution of a pipeline in a local Python environment.</p>
<p>Only works with a pipeline configuration package. Does not work with e.g. an edge configuration package.</p>
<p>Restriction: only linear pipelines are supported where the pipeline input variables are only used by one component,
each component uses only the outputs of the previous components, and the pipeline output only consists of variables from the last component.</p>
<p>If the caller specifies no <code>path</code>, the working directory is temporary and is removed unless an error occurs.
If the caller specifies a working directory with a <code>path</code> argument, the working directory is kept.
This behavior can be overridden using boolean parameter <code>cleanup</code>.</p>
<p>Currently, the pipeline runner supports both the current <code>process_input(data: dict)</code> entrypoint signature and the legacy
<code>run(data: str)</code> signature. If both entrypoints are present, <code>process_input()</code> takes precedence. Please note however that
<code>run()</code> is deprecated, and support for it will be removed in future versions of the pipeline runner.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">LocalPipelineRunner</span><span class="p">(</span>
    <span class="n">packageZip</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cleanup</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">loglevel</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>
</code></pre></div>

<h4 id="attributes">Attributes</h4>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>packageZip</td>
<td>path-like</td>
<td>Path to the pipeline configuration package.</td>
<td>None</td>
</tr>
<tr>
<td>path</td>
<td>path-like</td>
<td>Path to the working directory. If unset, a temporary directory is created.</td>
<td>None</td>
</tr>
<tr>
<td>cleanup</td>
<td>bool</td>
<td>If set, the working directory is kept when True, and deleted when False.             If unset, a temporary working directory is removed, and an explicit working directory is kept.             When an error occurs in a component, the working directory is kept regardless of this value.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">LocalPipelineRunner</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Simulates the execution of a pipeline in a local Python environment.</span>

<span class="sd">    Only works with a pipeline configuration package. Does not work with e.g. an edge configuration package.</span>

<span class="sd">    Restriction: only linear pipelines are supported where the pipeline input variables are only used by one component,</span>

<span class="sd">    each component uses only the outputs of the previous components, and the pipeline output only consists of variables from the last component.</span>

<span class="sd">    If the caller specifies no `path`, the working directory is temporary and is removed unless an error occurs.</span>

<span class="sd">    If the caller specifies a working directory with a `path` argument, the working directory is kept.</span>

<span class="sd">    This behavior can be overridden using boolean parameter `cleanup`.</span>

<span class="sd">    Currently, the pipeline runner supports both the current `process_input(data: dict)` entrypoint signature and the legacy</span>

<span class="sd">    `run(data: str)` signature. If both entrypoints are present, `process_input()` takes precedence. Please note however that</span>

<span class="sd">    `run()` is deprecated, and support for it will be removed in future versions of the pipeline runner.</span>

<span class="sd">    Args:</span>

<span class="sd">        packageZip (path-like): Path to the pipeline configuration package.</span>

<span class="sd">        path (path-like): Path to the working directory. If unset, a temporary directory is created.</span>

<span class="sd">        cleanup (bool): If set, the working directory is kept when True, and deleted when False. \</span>

<span class="sd">            If unset, a temporary working directory is removed, and an explicit working directory is kept. \</span>

<span class="sd">            When an error occurs in a component, the working directory is kept regardless of this value.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">packageZip</span><span class="p">:</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">cleanup</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb nb-Type">bool</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">loglevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Creates a new component LocalPipelineRunner for the provided pipeline configuration package.</span>

<span class="sd">        Only works with a pipeline configuration package. Does not work with e.g. an edge configuration package.</span>

<span class="sd">        Args:</span>

<span class="sd">            packageZip (path-like): Path to the pipeline configuration package.</span>

<span class="sd">            path (path-like): Path to the working directory. If unset a temporary directory will be created.</span>

<span class="sd">            cleanup (bool): If set, the working directory will be kept when True, and deleted when False. \</span>

<span class="sd">                If unset, a temporary working directory will be removed, and an explicit working directory will be kept. \</span>

<span class="sd">                When an error occurs in a component, the working directory will be kept regardless of this value.</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">:</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">packageZip</span><span class="p">)</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cleanup</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loglevel</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">:</span><span class="w"> </span><span class="n">Path</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-:]&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">timespec</span><span class="o">=</span><span class="s2">&quot;seconds&quot;</span><span class="p">))</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="n">True</span><span class="p">,</span><span class="w"> </span><span class="n">exist_ok</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">False</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;LocalPipelineRunner_{timestamp}_&quot;</span><span class="p">))</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">True</span>

<span class="w">        </span><span class="n">unzip_components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span>

<span class="w">        </span><span class="n">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zf</span><span class="p">:</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;runtime_config.yml&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="o">.</span><span class="n">stem</span>

<span class="w">                </span><span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

<span class="w">                </span><span class="n">unzip_components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span>

<span class="w">            </span><span class="k">else</span><span class="p">:</span>

<span class="w">                </span><span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">        </span><span class="n">try</span><span class="p">:</span>

<span class="w">            </span><span class="n">with</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;pipeline_config.yml&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cf</span><span class="p">:</span>

<span class="w">                </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span><span class="w"> </span><span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>

<span class="w">            </span><span class="n">components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataFlowPipeline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;components&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">components</span><span class="p">:</span>

<span class="w">                </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>

<span class="w">                </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">unzip_components</span><span class="p">:</span>

<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">components</span><span class="p">:</span>

<span class="w">                    </span><span class="n">component_zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;{component[&#39;name&#39;]}_{component[&#39;version&#39;]}.zip&quot;</span>

<span class="w">                    </span><span class="n">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;components&#39;</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">component_zip</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zf</span><span class="p">:</span>

<span class="w">                        </span><span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataFlowPipeline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipelineParameters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{}):</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">parameter</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameter</span>

<span class="w">        </span><span class="n">except</span><span class="w"> </span><span class="n">Exception</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="n">INVALID_PIPELINE_PACKAGE_MESSAGE</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">exception_type</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">traceback</span><span class="p">):</span>

<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">update_telemetry_data</span><span class="p">()</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing local pipeline runner environment...&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Leaving local pipeline runner environment in its final state at &#39;{self.workdir}&#39;&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">collect_telemetry_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Collects telemetry data about the platform, environment, industrial AI packages, and pipeline.</span>

<span class="sd">        Returns:</span>

<span class="sd">            dict: A dictionary containing the telemetry data.</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">][</span><span class="s2">&quot;os&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">][</span><span class="s2">&quot;release&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">][</span><span class="s2">&quot;python_version&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform</span><span class="o">.</span><span class="n">python_version</span><span class="p">()</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;locals: {locals()}&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">][</span><span class="s2">&quot;jupyter&quot;</span><span class="p">]</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">any</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">locals</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;__IPYTHON__&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;get_ipython&quot;</span><span class="p">])</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">][</span><span class="s2">&quot;gitlab_ci&quot;</span><span class="p">]</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s2">&quot;GITLAB_CI&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">][</span><span class="s2">&quot;azure_devops&quot;</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s2">&quot;TF_BUILD&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">][</span><span class="s2">&quot;github_actions&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s2">&quot;GITHUB_ACTIONS&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;industrial_ai&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="n">try</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;industrial_ai&quot;</span><span class="p">][</span><span class="s2">&quot;simaticai&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="s2">&quot;simaticai&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>

<span class="w">        </span><span class="n">except</span><span class="w"> </span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">DistributionNotFound</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;industrial_ai&quot;</span><span class="p">][</span><span class="s2">&quot;simaticai&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">try</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;industrial_ai&quot;</span><span class="p">][</span><span class="s2">&quot;vep-template-sdk&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="s2">&quot;vep-template-sdk&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>

<span class="w">        </span><span class="n">except</span><span class="w"> </span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">DistributionNotFound</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;industrial_ai&quot;</span><span class="p">][</span><span class="s2">&quot;vep-template-sdk&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;python_versions&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">component</span><span class="p">][</span><span class="s1">&#39;runtime&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">component</span><span class="p">][</span><span class="s1">&#39;runtime&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="p">))</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;file_extensions&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">component_dir</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>

<span class="w">            </span><span class="c1"># pathlib is_relative_to is deprecated since version 3.12, will be removed in version 3.14</span>

<span class="w">            </span><span class="n">excluded_dirs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set</span><span class="p">([</span><span class="n">component_dir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;.venv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component_dir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;__pyache__&#39;</span><span class="p">])</span>

<span class="w">            </span><span class="n">suffixes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">set</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">suffix</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">component_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="p">(</span><span class="n">any</span><span class="p">(</span><span class="n">excluded_dirs</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">parents</span><span class="p">))</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">f</span><span class="o">.</span><span class="n">suffix</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.zip&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.yml&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.yaml&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.html&quot;</span><span class="p">])))</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">suffix</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">suffixes</span><span class="p">:</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">suffix</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;file_extensions&quot;</span><span class="p">]:</span>

<span class="w">                    </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;file_extensions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">telemetry_data</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">update_telemetry_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Update the telemetry data and the package.</span>

<span class="sd">        This method updates the telemetry data by loading the existing data from a YAML file,</span>

<span class="sd">        or collecting new telemetry data if the file doesn&#39;t exist. It then updates the</span>

<span class="sd">        &quot;last_run&quot; field of the telemetry data with the current timestamp. The updated</span>

<span class="sd">        telemetry data is then written back to the YAML file.</span>

<span class="sd">        If the package contains a different version of the telemetry data file, a new package</span>

<span class="sd">        is created with the updated telemetry data. Otherwise, the existing package is</span>

<span class="sd">        overwritten with the new package containing the updated telemetry data.</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating telemetry data and the package&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">telemetry_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;telemetry_data.yml&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">telemetry_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">telemetry_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">collect_telemetry_data</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;last_run&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">telemetry_data</span><span class="p">))</span>

<span class="w">        </span><span class="n">config_package</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span>

<span class="w">        </span><span class="n">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zip_read</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">zip_read</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">TELEMETRY_YAML</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TELEMETRY_YAML</span><span class="p">:</span>

<span class="w">                    </span><span class="n">config_package</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span>

<span class="w">                    </span><span class="k">break</span>

<span class="w">        </span><span class="n">new_zip_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;{Path(self.package_zip).stem}_tested.zip&quot;</span>

<span class="w">        </span><span class="n">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zip_read</span><span class="p">:</span>

<span class="w">            </span><span class="n">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">new_zip_path</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zip_write</span><span class="p">:</span>

<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">zip_read</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">TELEMETRY_YAML</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">file</span><span class="p">:</span>

<span class="w">                        </span><span class="n">filepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zip_read</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

<span class="w">                        </span><span class="n">zip_write</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span><span class="w"> </span><span class="n">arcname</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

<span class="w">                    </span><span class="k">else</span><span class="p">:</span>

<span class="w">                        </span><span class="n">zip_write</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">telemetry_path</span><span class="p">,</span><span class="w"> </span><span class="n">arcname</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">config_package</span><span class="p">:</span>

<span class="w">            </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">new_zip_path</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">new_sha_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;{Path(self.package_zip).stem}_tested.sha256&quot;</span>

<span class="w">            </span><span class="n">new_sha_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">calc_sha</span><span class="p">(</span><span class="n">new_zip_path</span><span class="p">))</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_install_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">,</span><span class="w"> </span><span class="n">no_index</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span><span class="p">):</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Installing requirements...&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>

<span class="w">            </span><span class="n">f</span><span class="s2">&quot;{component[&#39;bin_path&#39;] / &#39;python&#39;}&quot;</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pip&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;install&quot;</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;--no-python-version-warning&quot;</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;--no-warn-script-location&quot;</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;-f&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">package_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span>

<span class="w">            </span><span class="s2">&quot;-r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">REQUIREMENTS_TXT</span><span class="w"> </span><span class="p">]</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">no_index</span><span class="p">:</span>

<span class="w">            </span><span class="n">cmd</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;--no-index&quot;</span><span class="w"> </span><span class="p">]</span>

<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">cwd</span><span class="o">=</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">text</span><span class="o">=</span><span class="n">True</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">returncode</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_install_from_packages_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">):</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_install_requirements</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">,</span><span class="w"> </span><span class="n">True</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_install_from_pypi_org</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">):</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_install_requirements</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">,</span><span class="w"> </span><span class="n">False</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_init_component_venv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">:</span><span class="w"> </span><span class="n">dict</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Creates a virtual environment in which the given component can run.</span>

<span class="sd">        Args:</span>

<span class="sd">            component (str): name of the selected component.</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Creating virtual environment for component &#39;{component[&#39;name&#39;]}&#39;...&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">context_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;.venv&quot;</span>

<span class="w">        </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">venv</span><span class="o">.</span><span class="n">EnvBuilder</span><span class="p">(</span><span class="n">with_pip</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>

<span class="w">        </span><span class="n">builder</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">context_dir</span><span class="p">))</span>

<span class="w">        </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">(</span><span class="n">context_dir</span><span class="p">)</span>

<span class="w">        </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;bin_path&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bin_path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Component bin path: {component[&#39;bin_path&#39;]}&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Upgrading pip...&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;{component[&#39;bin_path&#39;] / &#39;python&#39;}&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pip&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;install&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pip&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--upgrade&quot;</span><span class="p">]</span>

<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">cwd</span><span class="o">=</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">text</span><span class="o">=</span><span class="n">True</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Error upgrading pip:</span><span class="se">\n</span><span class="s2">{result.stderr}&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">try</span><span class="p">:</span>

<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_install_logmodule</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;bin_path&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">])</span>

<span class="w">        </span><span class="n">except</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">err</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The &#39;simaticai&#39; Python package is either not installed or does not contain package &#39;log_module&#39;.&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">None</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Error installing log_module:</span><span class="se">\n</span><span class="s2">{result.stderr}&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">req_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;requirements.list&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">req_list</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">REQUIREMENTS_TXT</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

<span class="w">            </span><span class="n">dependencies</span><span class="p">,</span><span class="w"> </span><span class="n">extra_index</span><span class="p">,</span><span class="w"> </span><span class="n">index_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_requirements</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">REQUIREMENTS_TXT</span><span class="p">)</span>

<span class="w">            </span><span class="n">requirements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;#&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dependencies</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="w">            </span><span class="n">req_list</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">requirements</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&#39;{REQUIREMENTS_TXT}&#39; was not found. No additional dependencies were installed.&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="k">return</span>

<span class="w">        </span><span class="n">package_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PYTHON_PACKAGES</span>

<span class="w">        </span><span class="n">package_zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PYTHON_PACKAGES_ZIP</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Extracting {PYTHON_PACKAGES_ZIP}&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">package_zip</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

<span class="w">            </span><span class="n">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">package_zip</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zf</span><span class="p">:</span>

<span class="w">                </span><span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">package_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;There is no {PYTHON_PACKAGES_ZIP} to extract.&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="n">package_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="n">True</span><span class="p">,</span><span class="w"> </span><span class="n">exist_ok</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>

<span class="w">        </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_install_from_packages_zip</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">success</span><span class="p">:</span>

<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;Warning! Could not install dependencies from {PYTHON_PACKAGES_ZIP}. &quot;</span>

<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;Trying to install them from pypi.org. The resulting Python environment &quot;</span>

<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;may be significantly different than the targeted Python environment on the Edge Device!&quot;</span>

<span class="w">            </span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="w">            </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_install_from_pypi_org</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">package_dir</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">success</span><span class="p">:</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span>

<span class="w">                </span><span class="n">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Error installing requirements:</span><span class="se">\n</span><span class="s2">{result.stderr}&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="err">@</span><span class="n">staticmethod</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_install_logmodule</span><span class="p">(</span><span class="n">bin_path</span><span class="p">,</span><span class="w"> </span><span class="n">env_dir</span><span class="p">):</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Installing LogModule...&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">try</span><span class="p">:</span>

<span class="w">            </span><span class="n">package_paths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">importlib_metadata</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;simaticai&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="nb">assert</span><span class="w"> </span><span class="n">package_paths</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span>

<span class="w">            </span><span class="n">logger_wheel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">package_paths</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;log_module&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">locate</span><span class="p">()</span>

<span class="w">        </span><span class="n">except</span><span class="w"> </span><span class="n">Exception</span><span class="p">:</span>

<span class="w">            </span><span class="n">from</span><span class="w"> </span><span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">Distribution</span>

<span class="w">            </span><span class="n">direct_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Distribution</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="s2">&quot;simaticai&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="s2">&quot;direct_url.json&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="nb">assert</span><span class="w"> </span><span class="n">direct_url</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span>

<span class="w">            </span><span class="n">direct_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">direct_url</span><span class="p">)[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>

<span class="w">            </span><span class="n">direct_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">direct_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="w">            </span><span class="n">direct_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">direct_url</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;simaticai&#39;</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;data&#39;</span>

<span class="w">            </span><span class="n">paths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">direct_url</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;*.whl&#39;</span><span class="p">))</span>

<span class="w">            </span><span class="n">logger_wheel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">paths</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;log_module&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

<span class="w">        </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;{bin_path / &#39;pip&#39;}&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;install&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--no-python-version-warning&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--no-warn-script-location&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">logger_wheel</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;joblib&quot;</span><span class="p">]</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">cwd</span><span class="o">=</span><span class="n">env_dir</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="o">=</span><span class="n">True</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">run_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dict</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">]])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dict</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">]]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Runs the component in its virtual environment with the given input.</span>

<span class="sd">        This environment is created according to `requirements.txt` in the package.</span>

<span class="sd">        Additionally &#39;joblib&#39; and the mock `log_module` is automatically installed in this virtual environment.</span>

<span class="sd">        The input data can be a single input record in a dictionary or a batch of input records in a list of dictionaries.</span>

<span class="sd">        The supplied input data is saved as `inputs.joblib` in the component runtime directory, and the output is saved as `output.joblib`.</span>

<span class="sd">        Args:</span>

<span class="sd">            name (str): The name of the component to be executed.</span>

<span class="sd">            data (dict or list): One or more input records for the component.</span>

<span class="sd">        Returns:</span>

<span class="sd">            dict / list: A list of dictionaries for outputs if there were no errors and field `ready` is true.</span>

<span class="sd">            If the input was a single dict, then a single dict (the first item of the list) or None if there is no output.</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;Invalid component name: {name}&quot;</span>

<span class="w">        </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;runtime&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gpuruntime&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;Can not run component &#39;{name}&#39;: Runtime type is nor &#39;python&#39; or &#39;gpuruntime&#39;&quot;</span>

<span class="w">        </span><span class="n">input_payload_path</span><span class="p">:</span><span class="w"> </span><span class="n">Path</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;input.joblib&quot;</span>

<span class="w">        </span><span class="n">output_payload_path</span><span class="p">:</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;output.joblib&quot;</span>

<span class="w">        </span><span class="n">batch_input</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">][</span><span class="s2">&quot;inputBatch&quot;</span><span class="p">]</span><span class="w">  </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Yes&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">False</span>

<span class="w">        </span><span class="n">batch_output</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">][</span><span class="s2">&quot;outputBatch&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Yes&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">False</span>

<span class="w">        </span><span class="c1"># Validate and serialize input payload</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;Can not run component &#39;{name}&#39; without input.&quot;</span>

<span class="w">        </span><span class="n">input_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">[</span><span class="n">data</span><span class="p">]</span>

<span class="w">        </span><span class="n">validate_payload</span><span class="p">(</span><span class="n">input_payload</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;inputType&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">batch_input</span><span class="p">)</span>

<span class="w">        </span><span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">input_payload</span><span class="p">,</span><span class="w"> </span><span class="n">input_payload_path</span><span class="p">)</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Input payload saved as &#39;{input_payload_path}&#39;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Assemble command for runnig component</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;runtime&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># Version check for Python</span>

<span class="w">            </span><span class="n">e_major</span><span class="p">,</span><span class="w"> </span><span class="n">e_minor</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span>

<span class="w">            </span><span class="n">c_major</span><span class="p">,</span><span class="w"> </span><span class="n">c_minor</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;runtime&quot;</span><span class="p">][</span><span class="s2">&quot;version&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;{e_major}.{e_minor}&quot;</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;{c_major}.{c_minor}&quot;</span><span class="p">:</span>

<span class="w">                </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;The local python version ({e_major}.{e_minor}) and the python version defined for the component ({c_major}.{c_minor}) are different.&quot;</span>

<span class="w">                </span><span class="n">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot; Testing will be done using dependencies that corresponds to the python version of your development environment.&quot;</span>

<span class="w">                </span><span class="n">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot; Pipeline behavior on AI Inference Server might be different.&quot;</span>

<span class="w">                </span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">_init_component_venv</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;run_component.py&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">])</span>

<span class="w">            </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;run_component&#39;</span><span class="p">,</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;entrypoint&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span>

<span class="w">                </span><span class="s2">&quot;-p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span><span class="w"> </span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;defaultValue&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()}),</span>

<span class="w">                </span><span class="s2">&quot;-r&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;requirements.list&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span>

<span class="w">            </span><span class="p">]</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># gpuruntime step requires Python environment with onnxruntime installed</span>

<span class="w">            </span><span class="c1"># TODO: check gpuruntime version if needed</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;gpuruntime_requirements.txt&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">REQUIREMENTS_TXT</span><span class="p">)</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">_init_component_venv</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;run_gpuruntime_component.py&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">])</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;model_config_pb2.py&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">])</span>

<span class="w">            </span><span class="n">model_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;entrypoint&quot;</span><span class="p">])</span>

<span class="w">            </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;run_gpuruntime_component&#39;</span><span class="p">,</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span>

<span class="w">                </span><span class="s2">&quot;-c&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;config.pbtxt&quot;</span><span class="p">),</span>

<span class="w">            </span><span class="p">]</span>

<span class="w">        </span><span class="n">args</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span>

<span class="w">            </span><span class="s2">&quot;-i&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">input_payload_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;-o&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">output_payload_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;-ll&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

<span class="w">        </span><span class="p">]</span>

<span class="w">        </span><span class="c1"># Run the component in the created Python environment</span>

<span class="w">        </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;bin_path&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="p">)]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">args</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running command: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

<span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">cwd</span><span class="o">=</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>

<span class="w">                </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

<span class="w">        </span><span class="n">returncode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">returncode</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">RETURN_CODE_OK</span><span class="p">,</span><span class="w"> </span><span class="n">RETURN_CODE_DEPRECATED</span><span class="p">]:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>

<span class="s2">There was an error while running component &#39;{name}&#39;.</span>

<span class="s2">You can check the test results in directory &#39;{component[&#39;env_dir&#39;]}&#39;</span>

<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">response_wrapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">returncode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RETURN_CODE_DEPRECATED</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">False</span>

<span class="w">        </span><span class="c1"># Deserialize and validate output payload</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Loading output payload from &#39;{output_payload_path}&#39;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">output_payload_path</span><span class="p">)</span>

<span class="w">        </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">output_payload</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">[</span><span class="n">output_payload</span><span class="p">]</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">response_wrapped</span><span class="p">:</span>

<span class="w">            </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;ready&#39;</span><span class="p">]]</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">output</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="p">]</span>

<span class="w">        </span><span class="n">validate_payload</span><span class="p">(</span><span class="n">output_payload</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;outputType&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">batch_output</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Only return the first item if the input was a single item, or None if there are no valid results.</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">output_payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">output_payload</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">None</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">:</span><span class="w"> </span><span class="n">dict</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Validates and updates pipeline parameters.</span>

<span class="sd">        The elements of the dictionary must match the parameters specified in the pipeline configuration package.</span>

<span class="sd">        If any of the names or types does not match, all parameters will remain untouched.</span>

<span class="sd">        Args:</span>

<span class="sd">            parameters (dict): names and values of parameters to update</span>

<span class="sd">        Raises:</span>

<span class="sd">            AssertionError:</span>

<span class="sd">                When:</span>

<span class="sd">                - either `name` is not in the configured parameters,</span>

<span class="sd">                - or `defaultValue` type is different from the configured one</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">type_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">):</span>

<span class="w">                </span><span class="n">raise</span><span class="w"> </span><span class="n">AssertionError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Pipeline has no parameters with the name &#39;{key}&#39; and type &#39;{type_map.get(type(value).__name__)}&#39;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;defaultValue&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">run_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dict</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dict</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">]]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Runs all the components sequentially, assuming the output of a component is only consumed by the next.</span>

<span class="sd">        The input data can be a single input record in a dictionary or a batch of input records in a list of dictionaries.</span>

<span class="sd">        For each component the supplied input data is saved as `input.joblib` in the component runtime directory,</span>

<span class="sd">        and the output is saved as `output.joblib`.</span>

<span class="sd">        Args:</span>

<span class="sd">            payload (dict or list): One or more input records for the pipeline.</span>

<span class="sd">        Returns:</span>

<span class="sd">            The output of the last component.</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

<span class="w">            </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">run_component</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">payload</span>
</code></pre></div>

</details>
<hr />
<h4 id="methods">Methods</h4>
<h4 id="collect_telemetry_data">collect_telemetry_data</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">collect_telemetry_data</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>Collects telemetry data about the platform, environment, industrial AI packages, and pipeline.</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dict</td>
<td>A dictionary containing the telemetry data.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">collect_telemetry_data</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Collects telemetry data about the platform, environment, industrial AI packages, and pipeline.</span>

<span class="ss">        Returns:</span>

<span class="ss">            dict: A dictionary containing the telemetry data.</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;platform&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;platform&quot;</span><span class="o">][</span><span class="n">&quot;os&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform</span><span class="p">.</span><span class="k">system</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;platform&quot;</span><span class="o">][</span><span class="n">&quot;release&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform</span><span class="p">.</span><span class="k">release</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;platform&quot;</span><span class="o">][</span><span class="n">&quot;python_version&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform</span><span class="p">.</span><span class="n">python_version</span><span class="p">()</span>

<span class="w">        </span><span class="n">_logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;locals: {locals()}&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;environment&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;environment&quot;</span><span class="o">][</span><span class="n">&quot;jupyter&quot;</span><span class="o">]</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="ow">any</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">locals</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;__IPYTHON__&quot;, &quot;get_ipython&quot;</span><span class="o">]</span><span class="p">)</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;environment&quot;</span><span class="o">][</span><span class="n">&quot;gitlab_ci&quot;</span><span class="o">]</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ss">&quot;GITLAB_CI&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;environment&quot;</span><span class="o">][</span><span class="n">&quot;azure_devops&quot;</span><span class="o">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ss">&quot;TF_BUILD&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;environment&quot;</span><span class="o">][</span><span class="n">&quot;github_actions&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ss">&quot;GITHUB_ACTIONS&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;industrial_ai&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{}</span>

<span class="w">        </span><span class="k">try</span><span class="err">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;industrial_ai&quot;</span><span class="o">][</span><span class="n">&quot;simaticai&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pkg_resources</span><span class="p">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="ss">&quot;simaticai&quot;</span><span class="p">).</span><span class="n">version</span>

<span class="w">        </span><span class="ow">except</span><span class="w"> </span><span class="n">pkg_resources</span><span class="p">.</span><span class="nl">DistributionNotFound</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;industrial_ai&quot;</span><span class="o">][</span><span class="n">&quot;simaticai&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="k">try</span><span class="err">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;industrial_ai&quot;</span><span class="o">][</span><span class="n">&quot;vep-template-sdk&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pkg_resources</span><span class="p">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="ss">&quot;vep-template-sdk&quot;</span><span class="p">).</span><span class="n">version</span>

<span class="w">        </span><span class="ow">except</span><span class="w"> </span><span class="n">pkg_resources</span><span class="p">.</span><span class="nl">DistributionNotFound</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;industrial_ai&quot;</span><span class="o">][</span><span class="n">&quot;vep-template-sdk&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSG_NOT_FOUND</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;pipeline&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{}</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;pipeline&quot;</span><span class="o">][</span><span class="n">&quot;python_versions&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="k">set</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">components</span><span class="o">[</span><span class="n">component</span><span class="o">][</span><span class="n">&#39;runtime&#39;</span><span class="o">][</span><span class="n">&#39;version&#39;</span><span class="o">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">components</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">components</span><span class="o">[</span><span class="n">component</span><span class="o">][</span><span class="n">&#39;runtime&#39;</span><span class="o">][</span><span class="n">&#39;type&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="p">))</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;pipeline&quot;</span><span class="o">][</span><span class="n">&quot;file_extensions&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">component_dir</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">Path(self.workdir) / c for c in Path(self.workdir).rglob(&quot;*&quot;) if c.name in self.components.keys()</span><span class="o">]</span><span class="err">:</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">pathlib</span><span class="w"> </span><span class="n">is_relative_to</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">deprecated</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mf">3.12</span><span class="p">,</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">removed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mf">3.14</span>

<span class="w">            </span><span class="n">excluded_dirs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">set</span><span class="p">(</span><span class="o">[</span><span class="n">component_dir / &#39;.venv&#39;, component_dir / &#39;__pyache__&#39;</span><span class="o">]</span><span class="p">)</span>

<span class="w">            </span><span class="n">suffixes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="k">set</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">suffix</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">component_dir</span><span class="p">.</span><span class="n">rglob</span><span class="p">(</span><span class="ss">&quot;*&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="p">(</span><span class="ow">any</span><span class="p">(</span><span class="n">excluded_dirs</span><span class="p">.</span><span class="k">intersection</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">parents</span><span class="p">))</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">suffix</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;&quot;, &quot;.zip&quot;, &quot;.yml&quot;, &quot;.yaml&quot;, &quot;.html&quot;</span><span class="o">]</span><span class="p">)))</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">suffix</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">suffixes</span><span class="p">:</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">suffix</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;pipeline&quot;</span><span class="o">][</span><span class="n">&quot;file_extensions&quot;</span><span class="o">]</span><span class="err">:</span>

<span class="w">                    </span><span class="n">telemetry_data</span><span class="o">[</span><span class="n">&quot;pipeline&quot;</span><span class="o">][</span><span class="n">&quot;file_extensions&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">telemetry_data</span>
</code></pre></div>

</details>
<h4 id="run_component">run_component</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">run_component</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span>
</code></pre></div>

<p>Runs the component in its virtual environment with the given input.</p>
<p>This environment is created according to <code>requirements.txt</code> in the package.
Additionally 'joblib' and the mock <code>log_module</code> is automatically installed in this virtual environment.
The input data can be a single input record in a dictionary or a batch of input records in a list of dictionaries.
The supplied input data is saved as <code>inputs.joblib</code> in the component runtime directory, and the output is saved as <code>output.joblib</code>.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>str</td>
<td>The name of the component to be executed.</td>
<td>None</td>
</tr>
<tr>
<td>data</td>
<td>dict or list</td>
<td>One or more input records for the component.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>dict / list: A list of dictionaries for outputs if there were no errors and field <code>ready</code> is true.<br/>If the input was a single dict, then a single dict (the first item of the list) or None if there is no output.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">run_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dict</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">]])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dict</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">]]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Runs the component in its virtual environment with the given input.</span>

<span class="sd">        This environment is created according to `requirements.txt` in the package.</span>

<span class="sd">        Additionally &#39;joblib&#39; and the mock `log_module` is automatically installed in this virtual environment.</span>

<span class="sd">        The input data can be a single input record in a dictionary or a batch of input records in a list of dictionaries.</span>

<span class="sd">        The supplied input data is saved as `inputs.joblib` in the component runtime directory, and the output is saved as `output.joblib`.</span>

<span class="sd">        Args:</span>

<span class="sd">            name (str): The name of the component to be executed.</span>

<span class="sd">            data (dict or list): One or more input records for the component.</span>

<span class="sd">        Returns:</span>

<span class="sd">            dict / list: A list of dictionaries for outputs if there were no errors and field `ready` is true.</span>

<span class="sd">            If the input was a single dict, then a single dict (the first item of the list) or None if there is no output.</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;Invalid component name: {name}&quot;</span>

<span class="w">        </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;runtime&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gpuruntime&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;Can not run component &#39;{name}&#39;: Runtime type is nor &#39;python&#39; or &#39;gpuruntime&#39;&quot;</span>

<span class="w">        </span><span class="n">input_payload_path</span><span class="p">:</span><span class="w"> </span><span class="n">Path</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;input.joblib&quot;</span>

<span class="w">        </span><span class="n">output_payload_path</span><span class="p">:</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;output.joblib&quot;</span>

<span class="w">        </span><span class="n">batch_input</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">][</span><span class="s2">&quot;inputBatch&quot;</span><span class="p">]</span><span class="w">  </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Yes&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">False</span>

<span class="w">        </span><span class="n">batch_output</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">][</span><span class="s2">&quot;outputBatch&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Yes&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">False</span>

<span class="w">        </span><span class="c1"># Validate and serialize input payload</span>

<span class="w">        </span><span class="nb">assert</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;Can not run component &#39;{name}&#39; without input.&quot;</span>

<span class="w">        </span><span class="n">input_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">[</span><span class="n">data</span><span class="p">]</span>

<span class="w">        </span><span class="n">validate_payload</span><span class="p">(</span><span class="n">input_payload</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;inputType&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">batch_input</span><span class="p">)</span>

<span class="w">        </span><span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">input_payload</span><span class="p">,</span><span class="w"> </span><span class="n">input_payload_path</span><span class="p">)</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Input payload saved as &#39;{input_payload_path}&#39;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Assemble command for runnig component</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;runtime&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># Version check for Python</span>

<span class="w">            </span><span class="n">e_major</span><span class="p">,</span><span class="w"> </span><span class="n">e_minor</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span>

<span class="w">            </span><span class="n">c_major</span><span class="p">,</span><span class="w"> </span><span class="n">c_minor</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;runtime&quot;</span><span class="p">][</span><span class="s2">&quot;version&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;{e_major}.{e_minor}&quot;</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;{c_major}.{c_minor}&quot;</span><span class="p">:</span>

<span class="w">                </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;The local python version ({e_major}.{e_minor}) and the python version defined for the component ({c_major}.{c_minor}) are different.&quot;</span>

<span class="w">                </span><span class="n">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot; Testing will be done using dependencies that corresponds to the python version of your development environment.&quot;</span>

<span class="w">                </span><span class="n">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot; Pipeline behavior on AI Inference Server might be different.&quot;</span>

<span class="w">                </span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">_init_component_venv</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;run_component.py&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">])</span>

<span class="w">            </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;run_component&#39;</span><span class="p">,</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;entrypoint&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span>

<span class="w">                </span><span class="s2">&quot;-p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span><span class="w"> </span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;defaultValue&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()}),</span>

<span class="w">                </span><span class="s2">&quot;-r&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;requirements.list&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span>

<span class="w">            </span><span class="p">]</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="c1"># gpuruntime step requires Python environment with onnxruntime installed</span>

<span class="w">            </span><span class="c1"># TODO: check gpuruntime version if needed</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;gpuruntime_requirements.txt&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">REQUIREMENTS_TXT</span><span class="p">)</span>

<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">_init_component_venv</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;run_gpuruntime_component.py&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">])</span>

<span class="w">                </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_runner_path</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;model_config_pb2.py&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">])</span>

<span class="w">            </span><span class="n">model_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;entrypoint&quot;</span><span class="p">])</span>

<span class="w">            </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;run_gpuruntime_component&#39;</span><span class="p">,</span>

<span class="w">                </span><span class="s2">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span>

<span class="w">                </span><span class="s2">&quot;-c&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;config.pbtxt&quot;</span><span class="p">),</span>

<span class="w">            </span><span class="p">]</span>

<span class="w">        </span><span class="n">args</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span>

<span class="w">            </span><span class="s2">&quot;-i&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">input_payload_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;-o&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">output_payload_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>

<span class="w">            </span><span class="s2">&quot;-ll&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

<span class="w">        </span><span class="p">]</span>

<span class="w">        </span><span class="c1"># Run the component in the created Python environment</span>

<span class="w">        </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s1">&#39;bin_path&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;python&#39;</span><span class="p">)]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">args</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running command: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

<span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">cwd</span><span class="o">=</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;env_dir&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>

<span class="w">                </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

<span class="w">        </span><span class="n">returncode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">returncode</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">RETURN_CODE_OK</span><span class="p">,</span><span class="w"> </span><span class="n">RETURN_CODE_DEPRECATED</span><span class="p">]:</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>

<span class="s2">There was an error while running component &#39;{name}&#39;.</span>

<span class="s2">You can check the test results in directory &#39;{component[&#39;env_dir&#39;]}&#39;</span>

<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">response_wrapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">returncode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RETURN_CODE_DEPRECATED</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">False</span>

<span class="w">        </span><span class="c1"># Deserialize and validate output payload</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Loading output payload from &#39;{output_payload_path}&#39;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">output_payload_path</span><span class="p">)</span>

<span class="w">        </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">output_payload</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">[</span><span class="n">output_payload</span><span class="p">]</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">response_wrapped</span><span class="p">:</span>

<span class="w">            </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;ready&#39;</span><span class="p">]]</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">output_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">output</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">None</span><span class="p">]</span>

<span class="w">        </span><span class="n">validate_payload</span><span class="p">(</span><span class="n">output_payload</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;outputType&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">batch_output</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># Only return the first item if the input was a single item, or None if there are no valid results.</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">output_payload</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">output_payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">output_payload</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">None</span>
</code></pre></div>

</details>
<h4 id="run_pipeline">run_pipeline</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">run_pipeline</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span>
</code></pre></div>

<p>Runs all the components sequentially, assuming the output of a component is only consumed by the next.</p>
<p>The input data can be a single input record in a dictionary or a batch of input records in a list of dictionaries.
For each component the supplied input data is saved as <code>input.joblib</code> in the component runtime directory,
and the output is saved as <code>output.joblib</code>.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>payload</td>
<td>dict or list</td>
<td>One or more input records for the pipeline.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>The output of the last component.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">run_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dict</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dict</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">]]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Runs all the components sequentially, assuming the output of a component is only consumed by the next.</span>

<span class="sd">        The input data can be a single input record in a dictionary or a batch of input records in a list of dictionaries.</span>

<span class="sd">        For each component the supplied input data is saved as `input.joblib` in the component runtime directory,</span>

<span class="sd">        and the output is saved as `output.joblib`.</span>

<span class="sd">        Args:</span>

<span class="sd">            payload (dict or list): One or more input records for the pipeline.</span>

<span class="sd">        Returns:</span>

<span class="sd">            The output of the last component.</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

<span class="w">            </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">run_component</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">payload</span>
</code></pre></div>

</details>
<h4 id="update_parameters">update_parameters</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_parameters</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span>
<span class="p">)</span>
</code></pre></div>

<p>Validates and updates pipeline parameters.</p>
<p>The elements of the dictionary must match the parameters specified in the pipeline configuration package.
If any of the names or types does not match, all parameters will remain untouched.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>parameters</td>
<td>dict</td>
<td>names and values of parameters to update</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Raises:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>AssertionError</td>
<td>When:<br/>- either <code>name</code> is not in the configured parameters,<br/>- or <code>defaultValue</code> type is different from the configured one</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">update_parameters</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">parameters</span><span class="p">:</span><span class="w"> </span><span class="nx">dict</span><span class="p">):</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;</span>

<span class="s">        Validates and updates pipeline parameters.</span>

<span class="s">        The elements of the dictionary must match the parameters specified in the pipeline configuration package.</span>

<span class="s">        If any of the names or types does not match, all parameters will remain untouched.</span>

<span class="s">        Args:</span>

<span class="s">            parameters (dict): names and values of parameters to update</span>

<span class="s">        Raises:</span>

<span class="s">            AssertionError:</span>

<span class="s">                When:</span>

<span class="s">                - either `name` is not in the configured parameters,</span>

<span class="s">                - or `defaultValue` type is different from the configured one</span>

<span class="s">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="nx">value</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">parameters</span><span class="p">.</span><span class="nx">items</span><span class="p">():</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">keys</span><span class="p">()</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">parameters</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="s">&quot;type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">type_map</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="k">type</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">__name__</span><span class="p">):</span>

<span class="w">                </span><span class="nx">raise</span><span class="w"> </span><span class="nx">AssertionError</span><span class="p">(</span><span class="nx">f</span><span class="s">&quot;Pipeline has no parameters with the name &#39;{key}&#39; and type &#39;{type_map.get(type(value).__name__)}&#39;&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">parameters</span><span class="p">.</span><span class="nx">items</span><span class="p">():</span>

<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">parameters</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="s">&quot;defaultValue&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">value</span>
</code></pre></div>

</details>
<h4 id="update_telemetry_data">update_telemetry_data</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_telemetry_data</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>Update the telemetry data and the package.</p>
<p>This method updates the telemetry data by loading the existing data from a YAML file,
or collecting new telemetry data if the file doesn't exist. It then updates the
"last_run" field of the telemetry data with the current timestamp. The updated
telemetry data is then written back to the YAML file.</p>
<p>If the package contains a different version of the telemetry data file, a new package
is created with the updated telemetry data. Otherwise, the existing package is
overwritten with the new package containing the updated telemetry data.</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">update_telemetry_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Update the telemetry data and the package.</span>

<span class="sd">        This method updates the telemetry data by loading the existing data from a YAML file,</span>

<span class="sd">        or collecting new telemetry data if the file doesn&#39;t exist. It then updates the</span>

<span class="sd">        &quot;last_run&quot; field of the telemetry data with the current timestamp. The updated</span>

<span class="sd">        telemetry data is then written back to the YAML file.</span>

<span class="sd">        If the package contains a different version of the telemetry data file, a new package</span>

<span class="sd">        is created with the updated telemetry data. Otherwise, the existing package is</span>

<span class="sd">        overwritten with the new package containing the updated telemetry data.</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating telemetry data and the package&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">telemetry_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s2">&quot;telemetry_data.yml&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">telemetry_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">telemetry_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">telemetry_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">collect_telemetry_data</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_data</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;last_run&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

<span class="w">        </span><span class="n">telemetry_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">telemetry_data</span><span class="p">))</span>

<span class="w">        </span><span class="n">config_package</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span>

<span class="w">        </span><span class="n">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zip_read</span><span class="p">:</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">zip_read</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">TELEMETRY_YAML</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TELEMETRY_YAML</span><span class="p">:</span>

<span class="w">                    </span><span class="n">config_package</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">True</span>

<span class="w">                    </span><span class="k">break</span>

<span class="w">        </span><span class="n">new_zip_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;{Path(self.package_zip).stem}_tested.zip&quot;</span>

<span class="w">        </span><span class="n">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zip_read</span><span class="p">:</span>

<span class="w">            </span><span class="n">with</span><span class="w"> </span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">new_zip_path</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zip_write</span><span class="p">:</span>

<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">zip_read</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">TELEMETRY_YAML</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">file</span><span class="p">:</span>

<span class="w">                        </span><span class="n">filepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zip_read</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

<span class="w">                        </span><span class="n">zip_write</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span><span class="w"> </span><span class="n">arcname</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

<span class="w">                    </span><span class="k">else</span><span class="p">:</span>

<span class="w">                        </span><span class="n">zip_write</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">telemetry_path</span><span class="p">,</span><span class="w"> </span><span class="n">arcname</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">config_package</span><span class="p">:</span>

<span class="w">            </span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">new_zip_path</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span>

<span class="w">        </span><span class="k">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">new_sha_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_zip</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">f</span><span class="s2">&quot;{Path(self.package_zip).stem}_tested.sha256&quot;</span>

<span class="w">            </span><span class="n">new_sha_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">calc_sha</span><span class="p">(</span><span class="n">new_zip_path</span><span class="p">))</span>
</code></pre></div>

</details>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="index.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Index" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Index
            </div>
          </div>
        </a>
      
      
        
        <a href="pipeline_validator.html" class="md-footer__link md-footer__link--next" aria-label="Next: Pipeline Validator" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Pipeline Validator
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright (C) Siemens AG 2021. All Rights Reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.48f2be22.min.js"></script>
      
    
  </body>
</html>